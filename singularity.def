Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%labels
    Author Thomas M. Brice
    Version 1.0
    Description Akkadian NMT environment with ByT5, PyTorch, and FAISS for GPU clusters

%help
    This container provides a complete environment for the Akkadian NMT project:
    - PyTorch 2.1+ with CUDA 11.8 support
    - Hugging Face Transformers (ByT5 models)
    - FAISS for vector similarity search
    - Sentence transformers for embeddings
    - All dependencies from requirements.txt

    Usage:
        singularity exec --nv akklang.sif python scripts/train.py

%environment
    export PATH=/opt/conda/bin:$PATH
    export PYTHONPATH=/akklang:$PYTHONPATH
    export TRANSFORMERS_CACHE=/akklang/.cache/huggingface
    export HF_HOME=/akklang/.cache/huggingface
    export TORCH_HOME=/akklang/.cache/torch
    export CUDA_VISIBLE_DEVICES=0

%post
    # Update and install system dependencies
    apt-get update && apt-get install -y \
        wget \
        bzip2 \
        ca-certificates \
        git \
        vim \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    export PATH=/opt/conda/bin:$PATH

    # Create Python 3.10 environment
    conda create -n akkadian python=3.10 -y
    . /opt/conda/etc/profile.d/conda.sh
    conda activate akkadian

    # Install PyTorch with CUDA support
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

    # Install core dependencies
    pip install transformers==4.36.0
    pip install accelerate==0.25.0
    pip install datasets==2.15.0
    pip install sentencepiece==0.1.99
    pip install protobuf==3.20.3

    # Install evaluation metrics
    pip install sacrebleu==2.3.1
    pip install evaluate==0.4.1

    # Install FAISS for GPU
    conda install -c conda-forge faiss-gpu -y

    # Install retrieval and embedding libraries
    pip install sentence-transformers==2.2.2
    pip install faiss-cpu==1.7.4  # Fallback for CPU

    # Install data processing libraries
    pip install pandas==2.1.4
    pip install numpy==1.26.2
    pip install scikit-learn==1.3.2
    pip install tqdm==4.66.1
    pip install pyyaml==6.0.1

    # Install optional visualization
    pip install matplotlib==3.8.2
    pip install seaborn==0.13.0

    # Install Jupyter for notebooks
    pip install jupyter==1.0.0
    pip install ipykernel==6.27.1

    # Clean up
    conda clean -a -y
    pip cache purge

    # Create cache directories
    mkdir -p /akklang/.cache/huggingface
    mkdir -p /akklang/.cache/torch

    # Make conda available in the container
    echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
    echo "conda activate akkadian" >> $SINGULARITY_ENVIRONMENT

%runscript
    #!/bin/bash
    exec "$@"

%test
    # Test CUDA availability
    python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda}')"

    # Test transformers
    python -c "import transformers; print(f'Transformers: {transformers.__version__}')"

    # Test FAISS
    python -c "import faiss; print(f'FAISS: {faiss.__version__}')"

    # Test sentence-transformers
    python -c "from sentence_transformers import SentenceTransformer; print('Sentence transformers: OK')"
